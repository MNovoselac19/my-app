<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Drag Me to Chicago</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    :root {
      --primary: #41B6E6;
      --secondary: #EF002B;
      --bg: #FFFFFF;
      --text: #0a0a0a;
      --muted: #888;
      --border: #e0e0e0;
      --card-bg: #f9f9f9;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* HEADER */
    header {
      background: var(--text);
      padding: 0 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 3px solid var(--secondary);
    }

    .logo {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      color: var(--bg);
      letter-spacing: 2px;
      padding: 1rem 0;
      line-height: 1;
    }

    .logo span { color: var(--primary); }

    /* TAB NAV */
    nav {
      display: flex;
      gap: 0;
    }

    nav button {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.1rem;
      letter-spacing: 1.5px;
      background: none;
      border: none;
      color: #aaa;
      padding: 1.4rem 1.5rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: color 0.2s, border-color 0.2s;
      margin-bottom: -3px;
    }

    nav button.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    nav button:hover:not(.active) { color: #fff; }

    /* MAIN */
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    .view { display: none; }
    .view.active { display: block; }

    /* FILTERS */
    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filters input, .filters select {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      border: 1.5px solid var(--border);
      border-radius: 2px;
      background: #fff;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
    }

    .filters input:focus, .filters select:focus {
      border-color: var(--primary);
    }

    .filter-badge {
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--muted);
      margin-left: auto;
    }

    /* LIST VIEW */
    .event-list { display: flex; flex-direction: column; gap: 1px; background: var(--border); border: 1.5px solid var(--border); }

    .event-card {
      background: #fff;
      cursor: pointer;
      transition: background 0.15s;
      overflow: hidden;
    }

    .event-card:hover { background: #f0f8fd; }

    .event-card-header {
      display: grid;
      grid-template-columns: 90px 1fr 1fr 1fr;
      gap: 1rem;
      padding: 1rem 1.25rem;
      align-items: center;
    }

    .event-date-block {
      text-align: center;
      background: var(--text);
      color: #fff;
      padding: 0.4rem 0.5rem;
      border-radius: 2px;
      line-height: 1.2;
    }

    .event-date-block .month {
      font-size: 0.65rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--primary);
    }

    .event-date-block .day {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      line-height: 1;
    }

    .event-date-block .weekday {
      font-size: 0.65rem;
      color: #aaa;
      text-transform: uppercase;
    }

    .event-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.3rem;
      letter-spacing: 0.5px;
      color: var(--text);
    }

    .event-venue {
      font-size: 0.88rem;
      color: var(--muted);
    }

    .event-venue strong { color: var(--text); font-weight: 500; }

    .event-time {
      font-size: 0.85rem;
      color: var(--muted);
      text-align: right;
    }

    .expand-icon {
      font-size: 1.2rem;
      color: var(--primary);
      text-align: right;
      transition: transform 0.2s;
    }

    .event-card.open .expand-icon { transform: rotate(45deg); }

    /* EXPANDED DETAILS */
    .event-details {
      display: none;
      padding: 0 1.25rem 1.25rem 1.25rem;
      border-top: 1.5px solid var(--border);
      background: #fafeff;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .event-card.open .event-details { display: block; }

    .details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
      margin-top: 1rem;
    }

    .detail-section h4 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 0.95rem;
      letter-spacing: 1px;
      color: var(--primary);
      margin-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.25rem;
    }

    .performer-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .performer-tag {
      font-size: 0.8rem;
      background: var(--text);
      color: #fff;
      padding: 0.25rem 0.6rem;
      border-radius: 2px;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .performer-tag a {
      color: var(--primary);
      text-decoration: none;
      font-size: 0.75rem;
    }

    .performer-tag a:hover { text-decoration: underline; }

    .ticket-btn {
      display: inline-block;
      margin-top: 0.75rem;
      background: var(--secondary);
      color: #fff;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1rem;
      letter-spacing: 1.5px;
      padding: 0.6rem 1.5rem;
      text-decoration: none;
      border-radius: 2px;
      transition: opacity 0.2s;
    }

    .ticket-btn:hover { opacity: 0.85; }

    .price-tag {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--secondary);
      margin-top: 0.4rem;
    }

    .past-badge {
      font-size: 0.7rem;
      font-weight: 500;
      background: #eee;
      color: #999;
      padding: 0.15rem 0.5rem;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 0.5rem;
      vertical-align: middle;
    }

    /* CALENDAR VIEW */
    .calendar-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .cal-nav {
      background: none;
      border: 1.5px solid var(--border);
      font-size: 1.2rem;
      width: 36px; height: 36px;
      cursor: pointer;
      border-radius: 2px;
      display: flex; align-items: center; justify-content: center;
      transition: border-color 0.2s, color 0.2s;
    }

    .cal-nav:hover { border-color: var(--primary); color: var(--primary); }

    .cal-month-label {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.8rem;
      letter-spacing: 2px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border);
      border: 1.5px solid var(--border);
    }

    .cal-day-name {
      background: var(--text);
      color: #aaa;
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
      padding: 0.5rem;
    }

    .cal-cell {
      background: #fff;
      min-height: 90px;
      padding: 0.4rem;
      vertical-align: top;
    }

    .cal-cell.empty { background: #fafafa; }

    .cal-cell.today { background: #f0f8fd; }

    .cal-date {
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 0.3rem;
    }

    .cal-today-dot {
      display: inline-block;
      width: 18px; height: 18px;
      background: var(--primary);
      color: #fff;
      border-radius: 50%;
      font-size: 0.72rem;
      text-align: center;
      line-height: 18px;
      font-weight: 600;
    }

    .cal-event {
      font-size: 0.72rem;
      background: var(--text);
      color: #fff;
      padding: 0.15rem 0.4rem;
      margin-bottom: 0.2rem;
      border-radius: 2px;
      cursor: pointer;
      border-left: 3px solid var(--primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: background 0.15s;
    }

    .cal-event:hover { background: var(--primary); }

    /* MAP VIEW */
    #map {
      width: 100%;
      height: 560px;
      border: 1.5px solid var(--border);
      border-radius: 2px;
    }

    .leaflet-popup-content-wrapper {
      border-radius: 2px;
      font-family: 'DM Sans', sans-serif;
    }

    .map-popup h3 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.1rem;
      letter-spacing: 0.5px;
      margin-bottom: 0.25rem;
    }

    .map-popup p { font-size: 0.82rem; color: #555; margin: 0.1rem 0; }
    .map-popup a { color: var(--secondary); font-size: 0.82rem; }

    /* LOADING */
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--muted);
      font-size: 0.9rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .loading::after {
      content: '';
      display: block;
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      margin: 1rem auto 0;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .no-results {
      text-align: center;
      padding: 3rem;
      color: var(--muted);
      font-size: 0.9rem;
    }

    @media (max-width: 700px) {
      .event-card-header { grid-template-columns: 70px 1fr; }
      .event-time { display: none; }
      .details-grid { grid-template-columns: 1fr; }
      .logo { font-size: 1.4rem; }
      nav button { font-size: 0.9rem; padding: 1rem 0.8rem; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">Drag Me <span style="color:white">to</span><span> Chicago</span></div>
  <nav>
    <button class="active" onclick="switchView('list', this)">List</button>
    <button onclick="switchView('calendar', this)">Calendar</button>
    <button onclick="switchView('map', this)">Map</button>
  </nav>
</header>

<main>

  <!-- LIST VIEW -->
  <div id="view-list" class="view active">
    <div class="filters">
      <input type="text" id="search" placeholder="Search events, venues, performers…" oninput="renderList()"/>
      <select id="filter-time" onchange="renderList()">
        <option value="upcoming">Upcoming</option>
        <option value="past">Past</option>
        <option value="all">All Events</option>
      </select>
      <span class="filter-badge" id="result-count"></span>
    </div>
    <div id="event-list" class="event-list"><div class="loading">Loading events</div></div>
  </div>

  <!-- CALENDAR VIEW -->
  <div id="view-calendar" class="view">
    <div class="calendar-header">
      <button class="cal-nav" onclick="changeMonth(-1)">&#8592;</button>
      <div class="cal-month-label" id="cal-month-label"></div>
      <button class="cal-nav" onclick="changeMonth(1)">&#8594;</button>
    </div>
    <div id="calendar-grid" class="calendar-grid"><div class="loading">Loading</div></div>
  </div>

  <!-- MAP VIEW -->
  <div id="view-map" class="view">
    <div id="map"></div>
  </div>

</main>

<script>
  const API_URL = 'https://my-app-n9ct.onrender.com/api/data';
  let allEvents = [];
  let mapInitialized = false;
  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();

  // ── FETCH DATA ──────────────────────────────────────────────
  async function fetchData() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      allEvents = data.sort((a, b) => new Date(a.event_date) - new Date(b.event_date));
      renderList();
      renderCalendar();
    } catch (e) {
      document.getElementById('event-list').innerHTML = '<div class="no-results">Could not load events. Please try again later.</div>';
    }
  }

  // ── HELPERS ─────────────────────────────────────────────────
  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return {
      month: d.toLocaleString('en-US', { month: 'short' }).toUpperCase(),
      day: d.getDate(),
      weekday: d.toLocaleString('en-US', { weekday: 'short' }).toUpperCase(),
      full: d,
    };
  }

  function formatTime(t) {
    if (!t) return '';
    const [h, m] = t.split(':');
    const hr = parseInt(h);
    const ampm = hr >= 12 ? 'PM' : 'AM';
    return `${hr % 12 || 12}:${m} ${ampm}`;
  }

  function formatPrice(p) {
    if (!p) return null;
    // price seems stored in cents
    return p > 1000 ? `$${(p / 100).toFixed(0)}` : `$${p}`;
  }

  function getPerformers(ev) {
    const performers = [];
    for (let i = 1; i <= 20; i++) {
      if (ev[`performer_${i}`]) {
        performers.push({ name: ev[`performer_${i}`], insta: ev[`insta_handle_${i}`] });
      }
    }
    return performers;
  }

  function getEventName(ev) {
    return ev.Event_Name || ev.Venue || 'Drag Event';
  }

  function isPast(ev) {
    return new Date(ev.event_date) < new Date();
  }

  // ── LIST VIEW ───────────────────────────────────────────────
  function renderList() {
    const search = document.getElementById('search').value.toLowerCase();
    const timeFilter = document.getElementById('filter-time').value;
    const now = new Date();

    let events = allEvents.filter(ev => {
      const evDate = new Date(ev.event_date);
      if (timeFilter === 'upcoming' && evDate < now) return false;
      if (timeFilter === 'past' && evDate >= now) return false;

      if (search) {
        const haystack = [
          ev.Event_Name, ev.Venue, ev.Address_Short,
          ...Array.from({length: 20}, (_, i) => ev[`performer_${i+1}`])
        ].filter(Boolean).join(' ').toLowerCase();
        if (!haystack.includes(search)) return false;
      }
      return true;
    });

    document.getElementById('result-count').textContent = `${events.length} event${events.length !== 1 ? 's' : ''}`;

    if (!events.length) {
      document.getElementById('event-list').innerHTML = '<div class="no-results">No events found.</div>';
      return;
    }

    document.getElementById('event-list').innerHTML = events.map((ev, i) => {
      const d = formatDate(ev.event_date);
      const performers = getPerformers(ev);
      const price = formatPrice(ev.Ticket_Price);
      const past = isPast(ev);

      return `
        <div class="event-card" onclick="toggleCard(this)">
          <div class="event-card-header">
            <div class="event-date-block">
              <div class="month">${d.month}</div>
              <div class="day">${d.day}</div>
              <div class="weekday">${d.weekday}</div>
            </div>
            <div>
              <div class="event-name">${getEventName(ev)}${past ? '<span class="past-badge">Past</span>' : ''}</div>
              <div class="event-venue"><strong>${ev.Venue || ''}</strong></div>
            </div>
            <div class="event-venue">${ev.Address_Short || ''}</div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="event-time">
                ${formatTime(ev.Event_Start_Time)}${ev.Event_End_Time ? ' – ' + formatTime(ev.Event_End_Time) : ''}
              </div>
              <div class="expand-icon">+</div>
            </div>
          </div>
          <div class="event-details">
            <div class="details-grid">
              <div class="detail-section">
                <h4>Performers</h4>
                <div class="performer-list">
                  ${performers.length ? performers.map(p => `
                    <div class="performer-tag">
                      ${p.name}
                      ${p.insta ? `<a href="https://instagram.com/${p.insta.replace('@','')}" target="_blank">${p.insta}</a>` : ''}
                    </div>`).join('') : '<span style="color:var(--muted);font-size:.85rem">TBA</span>'}
                </div>
              </div>
              <div class="detail-section">
                <h4>Event Info</h4>
                <p style="font-size:.85rem;margin-bottom:.4rem">
                  <strong>Time:</strong> ${formatTime(ev.Event_Start_Time) || 'TBA'}${ev.Event_End_Time ? ' – ' + formatTime(ev.Event_End_Time) : ''}
                </p>
                <p style="font-size:.85rem;margin-bottom:.4rem">
                  <strong>Venue:</strong> ${ev.Venue || 'TBA'}
                  ${ev.Venue_Insta_Handle ? `<a href="https://instagram.com/${ev.Venue_Insta_Handle.replace('@','')}" target="_blank" style="color:var(--primary);margin-left:.4rem">${ev.Venue_Insta_Handle}</a>` : ''}
                </p>
                <p style="font-size:.85rem">${ev.Address_Short || ''}</p>
                ${price ? `<div class="price-tag">${price}</div>` : ''}
                ${ev.Ticket_Link ? `<a class="ticket-btn" href="${ev.Ticket_Link}" target="_blank">Get Tickets</a>` : ''}
              </div>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  function toggleCard(el) {
    el.classList.toggle('open');
  }

  // ── CALENDAR VIEW ───────────────────────────────────────────
  function renderCalendar() {
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    document.getElementById('cal-month-label').textContent = `${months[currentMonth]} ${currentYear}`;

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const today = new Date();

    const eventsThisMonth = allEvents.filter(ev => {
      const d = new Date(ev.event_date);
      return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
    });

    // Group by day
    const byDay = {};
    eventsThisMonth.forEach(ev => {
      const day = new Date(ev.event_date).getDate();
      if (!byDay[day]) byDay[day] = [];
      byDay[day].push(ev);
    });

    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    let html = dayNames.map(d => `<div class="cal-day-name">${d}</div>`).join('');

    // Empty cells
    for (let i = 0; i < firstDay; i++) html += '<div class="cal-cell empty"></div>';

    for (let d = 1; d <= daysInMonth; d++) {
      const isToday = today.getDate() === d && today.getMonth() === currentMonth && today.getFullYear() === currentYear;
      const dayEvents = byDay[d] || [];
      html += `<div class="cal-cell${isToday ? ' today' : ''}">
        <div class="cal-date">${isToday ? `<span class="cal-today-dot">${d}</span>` : d}</div>
        ${dayEvents.map(ev => `<div class="cal-event" title="${getEventName(ev)}" onclick="goToEvent('${ev.event_date}','${ev.Venue}')">${getEventName(ev)}</div>`).join('')}
      </div>`;
    }

    document.getElementById('calendar-grid').innerHTML = html;
  }

  function changeMonth(dir) {
    currentMonth += dir;
    if (currentMonth > 11) { currentMonth = 0; currentYear++; }
    if (currentMonth < 0) { currentMonth = 11; currentYear--; }
    renderCalendar();
  }

  function goToEvent(dateStr, venue) {
    switchView('list', document.querySelector('nav button'));
    document.getElementById('filter-time').value = 'all';
    document.getElementById('search').value = venue || '';
    renderList();
  }

  // ── MAP VIEW ────────────────────────────────────────────────
  function initMap() {
    if (mapInitialized) return;
    mapInitialized = true;

    const map = L.map('map').setView([41.8781, -87.6298], 12);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
      maxZoom: 19
    }).addTo(map);

    const primaryIcon = L.divIcon({
      html: `<div style="width:14px;height:14px;background:#EF002B;border:2px solid #fff;border-radius:50%;box-shadow:0 1px 4px rgba(0,0,0,.3)"></div>`,
      className: '',
      iconSize: [14, 14],
      iconAnchor: [7, 7],
    });

    const withCoords = allEvents.filter(ev => ev.Latitude && ev.Longitude);
    withCoords.forEach(ev => {
      const performers = getPerformers(ev);
      const price = formatPrice(ev.Ticket_Price);
      const d = formatDate(ev.event_date);

      const popup = `
        <div class="map-popup">
          <h3>${getEventName(ev)}</h3>
          <p>${d.weekday}, ${d.month} ${d.day} &bull; ${formatTime(ev.Event_Start_Time) || 'TBA'}</p>
          <p><strong>${ev.Venue}</strong> &bull; ${ev.Address_Short || ''}</p>
          ${performers.length ? `<p style="margin-top:.4rem">${performers.map(p=>p.name).join(', ')}</p>` : ''}
          ${price ? `<p style="color:#EF002B;font-weight:500">${price}</p>` : ''}
          ${ev.Ticket_Link ? `<a href="${ev.Ticket_Link}" target="_blank">Get Tickets →</a>` : ''}
        </div>`;

      L.marker([ev.Latitude, ev.Longitude], { icon: primaryIcon })
        .addTo(map)
        .bindPopup(popup);
    });
  }

  // ── VIEW SWITCHING ──────────────────────────────────────────
  function switchView(view, btn) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(`view-${view}`).classList.add('active');
    // find the correct button
    document.querySelectorAll('nav button').forEach(b => {
      if (b.textContent.toLowerCase() === view) b.classList.add('active');
    });
    if (view === 'map') setTimeout(initMap, 100);
  }

  fetchData();
</script>
</body>
</html>
